rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------
    // Users
    // ----------------------
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // ----------------------
    // Friend requests
    // ----------------------
    match /friend_requests/{requestId} {
      allow read, write: if request.auth != null;
    }

    // ----------------------
    // Groups
    // ----------------------
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        (
          !exists(/databases/$(database)/documents/groups/$(groupId)) ||
          get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid ||
          (
            resource.data.memberIds is list &&
            request.resource.data.memberIds is list &&
            request.resource.data.memberIds.size() >= resource.data.memberIds.size()
          )
        );
    }

    // ----------------------
    // Scores (leaderboards)
    // ----------------------
    match /scores/{scoreId} {
      allow read: if request.auth != null;

      allow write: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        (
          // Group leaderboard
          (request.resource.data.groupId != null && exists(/databases/$(database)/documents/groups/$(request.resource.data.groupId))) ||
          // Global leaderboard
          request.resource.data.global != null ||
          // School leaderboard
          request.resource.data.schoolId != null ||
          // Union/Pouroshava leaderboard
          request.resource.data.unionId != null ||
          // Upazila leaderboard
          request.resource.data.upazilaId != null ||
          // District leaderboard
          request.resource.data.districtId != null ||
          // Division leaderboard
          request.resource.data.divisionId != null
        );
    }

    // ----------------------
    // Test attempts
    // ----------------------
    match /test_attempts/{attemptId} {
      allow read: if request.auth != null;

      allow write: if request.auth != null
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.testId != null
                   && request.resource.data.score != null
                   && request.resource.data.totalQuestions != null
                   && request.resource.data.startedAt != null
                   && request.resource.data.finishedAt != null
                   // optional schoolId can be null or string
                   && (request.resource.data.schoolId == null || request.resource.data.schoolId is string)
    }

    // ----------------------
    // Leaderboards (optional read-only)
    // ----------------------
    match /leaderboards/{scope}/{id}/{period}/{userId} {
      allow read: if request.auth != null;
      allow write: if false; // write only via admin functions
    }

  }
}
